# e-commerce 요구사항 명세서

## 🔖 공통 조건

### 사전 등록 데이터
- 회원 정보는 미리 등록되어 있다.
- 회원 잔액(포인트)은 미리 등록되어 있다.
- 상품 정보는 미리 등록되어 있다.
- 발급 가능한 쿠폰 정보는 미리 등록되어 있다.

### 구현 제외 기능
- 회원가입 / 로그인 (인증/인가)
- 상품 등록 / 수정 / 삭제
- 쿠폰 생성 / 수정 / 삭제


---

## 1. 상품 (Product)

### 1.1 상품 목록 조회
- **기능**: 상품 목록 조회 (페이징, 검색)
- **입력**:
    - 페이지 번호
    - 페이지 크기
    - 검색어 (상품명, 선택사항)

### 1.2 상품 상세 조회
- **기능**: 상품 ID로 상품 정보 조회
- **조회 항목**: 상품명, 가격, 재고 수량

### 1.3 인기 상품 조회
- **기능**: 최근 3일간 판매량 기준 Top 5 상품 조회

---

## 2. 장바구니 (Cart)

### 2.1 장바구니 추가
- **기능**: 상품을 장바구니에 담기
- **입력**:
    - 사용자 ID
    - 상품 ID
    - 수량

### 2.2 장바구니 삭제
- **기능**: 장바구니에서 상품 제거
- **입력**:
    - 사용자 ID
    - 장바구니 항목 ID

### 2.3 장바구니 조회
- **기능**: 사용자별 장바구니 목록 조회
- **조회 정보**: 상품 정보, 수량, 금액

---

## 3. 주문 (Order)

### 3.1 주문 생성

#### 기능
장바구니 또는 즉시 구매로 주문 생성

#### 처리 흐름
1. 재고 확인
2. **재고 차감** (동시성 제어 필요)
3. 주문 생성 (상태: `PENDING`)

#### 주문 타입
- **장바구니 주문**: 장바구니의 전체 상품 주문
- **즉시 구매**: 단일 상품 직접 주문

#### 재고 차감
- 주문 생성 시 즉시 재고 차감
- 결제 실패 시 재고 복구

### 3.2 주문 조회
- **주문 상세 조회**: 특정 주문의 상세 정보
- **주문 목록 조회**: 사용자별 주문 이력

#### 주문 상태
- `PENDING`: 결제 대기
- `COMPLETED`: 결제 완료
- `CANCELLED`: 주문 취소

---

## 4. 결제 (Payment)

### 4.1 잔액 조회
- **기능**: 사용자 잔액 조회

### 4.2 잔액 충전
- **기능**: 사용자 잔액 충전
- **입력**:
    - 사용자 ID
    - 충전 금액

### 4.3 결제 실행

#### 기능
주문에 대한 결제 처리

#### 처리 흐름
1. 주문 확인 (`PENDING` 상태 검증)
2. 쿠폰 할인 적용 (선택사항)
3. 최종 결제 금액 계산
4. 잔액 확인
5. **잔액 차감** (동시성 제어 필요)
6. 주문 상태 변경 (`COMPLETED`)
7. 결제 내역 생성

#### 결제 실패 처리
- 잔액 부족 등으로 결제 실패 시:
    - 주문 시 차감된 재고 복구
    - 주문 상태 변경 (`CANCELLED`)

---

## 5. 쿠폰 (Coupon)

### 5.1 쿠폰 발급

#### 기능
선착순 쿠폰 발급

#### 처리 흐름
1. 쿠폰 수량 확인
2. **수량 차감** (동시성 제어 필요)
3. 사용자에게 쿠폰 발급

#### 쿠폰 정보
- 쿠폰명
- 할인 금액
- 발급 수량
- 유효 기간

### 5.2 쿠폰 조회
- **기능**: 사용자 보유 쿠폰 목록 조회
- **조회 정보**: 쿠폰명, 할인 금액, 사용 여부, 유효 기간

### 5.3 쿠폰 사용

#### 기능
결제 시 쿠폰 적용

#### 처리
- 쿠폰 유효성 검증 (소유 여부, 사용 여부, 유효 기간)
- 할인 금액 적용
- 쿠폰 사용 완료 처리

---

## 6. 외부 연동 (External Integration)

### 6.1 주문 데이터 전송

#### 기능
결제 완료 시 외부 시스템으로 주문 데이터 전송

#### 구현 방식
- 외부 API 호출 인터페이스 정의
- 실제 API 호출은 구현하지 않고 **로그 출력으로 대체**
- 예: `log.info("외부 시스템 전송: 주문ID={}, 금액={}", orderId, amount)`

#### 처리 원칙
- **외부 연동 실패해도 결제는 정상 완료**
- 트랜잭션과 분리하여 처리

---

## 🔒 동시성 제어 포인트

### 7.1 재고 차감
- **상황**: 여러 인스턴스에서 동시에 같은 상품 주문
- **요구사항**: 재고 정합성 보장, 재고 초과 주문 방지
- **해결**: DB 레벨 락 (낙관적 락 or 비관적 락)

### 7.2 쿠폰 발급
- **상황**: 선착순 쿠폰 동시 발급 요청
- **요구사항**: 설정 수량만큼만 발급, 수량 초과 방지
- **해결**: DB 레벨 락 (비관적 락)

### 7.3 잔액 차감
- **상황**: 동시에 여러 결제 요청
- **요구사항**: 잔액 정합성 보장, 잔액 초과 차감 방지
- **해결**: DB 레벨 락 (낙관적 락 or 비관적 락)

---

## 📊 API 목록 요약

| 도메인 | API | 비고 |
|--------|-----|------|
| 상품 | 상품 목록 조회 | 페이징, 검색 |
| 상품 | 상품 상세 조회 | |
| 상품 | 인기 상품 조회 | Top 5 |
| 장바구니 | 장바구니 추가 | |
| 장바구니 | 장바구니 삭제 | |
| 장바구니 | 장바구니 조회 | |
| 주문 | 주문 생성 | 동시성 제어 |
| 주문 | 주문 상세 조회 | |
| 주문 | 주문 목록 조회 | |
| 결제 | 잔액 조회 | |
| 결제 | 잔액 충전 | |
| 결제 | 결제 실행 | 동시성 제어 |
| 쿠폰 | 쿠폰 발급 | 동시성 제어 |
| 쿠폰 | 쿠폰 조회 | |
| 쿠폰 | 쿠폰 사용 | 결제 시 |
| 외부 연동 | 주문 데이터 전송 | 로그로 대체 |

**총 16개 API**